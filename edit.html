<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>Auftritts-Eingabe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
        .popup-alert {
            position: fixed;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%) translateY(100px);
            min-width: 320px;
            max-width: 90vw;
            z-index: 1055;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(.4,0,.2,1), transform 0.4s cubic-bezier(.4,0,.2,1);
        }
        .popup-alert.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }
        .move-btns {
            display: flex;
            flex-direction: row;
            gap: 0.25rem;
            align-items: stretch;
            height: 2.5rem;
        }
        .move-btns .btn {
            padding: 2px 8px;
            font-size: 1rem;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .remove-btn {
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drag-handle {
            cursor: grab;
            font-size: 1.5rem;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 2.5rem;
        }
        .sortable-ghost, .sortable-chosen, .sortable-drag, .sortable-selected {
            border: dashed;
        }
        .sortable-ghost {
            opacity: 0.4;
        }
        @media (min-width: 768px) {
            .gig-actions {
                flex-direction: row !important;
                align-items: center !important;
                justify-content: flex-end !important;
            }
        }
        @media (max-width: 767.98px) {
            .gig-actions {
                flex-direction: row !important;
                align-items: flex-end !important;
                justify-content: flex-end !important;
                gap: 0.5rem !important;
            }
            .move-btns, .remove-btn, .drag-handle {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
<!-- Theme Switcher Dropdown -->
<div class="dropdown position-fixed bottom-0 end-0 mb-3 me-3 bd-mode-toggle" style="z-index: 10;">
    <button class="btn btn-secondary border px-3 py-2 dropdown-toggle" id="bd-theme" type="button"
            data-bs-toggle="dropdown" aria-expanded="false"
            aria-label="Farbschema (hell/dunkel/auto)">
        <i class="bi bi-circle-half theme-icon-active"></i>
        <span id="bd-theme-text" class="ms-2"></span>
    </button>
    <ul class="dropdown-menu dropdown-menu-end shadow">
        <li>
            <button type="button" class="dropdown-item d-flex align-items-center"
                    data-bs-theme-value="light">
                <i class="bi bi-sun-fill me-2"></i>
                Hell
                <span class="ms-auto"></span>
            </button>
        </li>
        <li>
            <button type="button" class="dropdown-item d-flex align-items-center"
                    data-bs-theme-value="dark">
                <i class="bi bi-moon-stars-fill me-2"></i>
                Dunkel
                <span class="ms-auto"></span>
            </button>
        </li>
        <li>
            <button type="button" class="dropdown-item d-flex align-items-center active"
                    data-bs-theme-value="auto">
                <i class="bi bi-circle-half me-2"></i>
                Automatisch
                <span class="ms-auto"></span>
            </button>
        </li>
    </ul>
</div>
<div class="container my-4">
    <h1 class="mb-4">Druckluftmafia Auftritts-Editor</h1>
    <form id="gigsForm">
        <div id="gigsContainer"></div>
        <button type="button" class="btn btn-primary mt-2" id="addAuftritt"><i class="bi bi-plus-lg"></i></button>
        <hr>
        <div class="d-flex align-items-center gap-2">
            <input type="password" class="form-control" id="githubToken" placeholder="GitHub Token" style="max-width: 250px;">
            <button type="submit" class="btn btn-success">Absenden</button>
        </div>
    </form>
    <div id="response" class="mt-3"></div>
</div>
<!-- Popup-Alert-Container -->
<div id="popupAlertContainer"></div>
<script>
    function buildGigRow(index, gig = null) {
        return `
    <div class="card my-2 bg-primary-subtle text-primary-emphasis" data-index="${index}">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md">
            <label class="form-label" for="date_${index}">Datum</label>
            <input type="date" class="form-control" id="date_${index}" name="date" required value="${gig?.date ?? ''}">
          </div>
          <div class="col-12 col-md">
            <label class="form-label" for="location_${index}">Ort</label>
            <input type="text" class="form-control" id="location_${index}" name="location" required value="${gig?.location ?? ''}">
          </div>
          <div class="col-12 col-md">
            <label class="form-label" for="time_${index}">Uhrzeit</label>
            <input type="time" class="form-control" id="time_${index}" name="time" required value="${gig?.time ?? ''}">
          </div>
          <div class="col-12 col-md">
            <label class="form-label" for="desc_${index}">Beschreibung</label>
            <input type="text" class="form-control" id="desc_${index}" name="desc" required value="${gig?.desc ?? ''}">
          </div>
          <div class="col-12 col-md-auto mt-3 d-flex gig-actions flex-row align-items-end justify-content-end gap-2">
            <button type="button" class="btn btn-danger removeAuftritt remove-btn" title="Entfernen"><i class="bi bi-trash"></i></button>
            <div class="move-btns">
              <button type="button" class="btn btn-outline-primary move-up" title="Nach oben"><i class="bi bi-arrow-up"></i></button>
              <button type="button" class="btn btn-outline-primary move-down" title="Nach unten"><i class="bi bi-arrow-down"></i></button>
            </div>
            <span class="drag-handle" title="Zum Sortieren ziehen"><i class="bi bi-three-dots-vertical"></i></span>
          </div>
        </div>
      </div>
    </div>
  `;
    }

    function renderAlert(message, type = "success") {
        let icon = type === "success" ? "check-circle-fill" : "exclamation-triangle-fill";
        const container = document.getElementById("popupAlertContainer");
        container.innerHTML =
            `<div class="popup-alert alert alert-${type} alert-dismissible fade" role="alert">
                <i class="bi bi-${icon}"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        const alertElem = container.firstElementChild;
        // Zeige die Alert mit Animation
        setTimeout(() => alertElem.classList.add("show"), 10);
        // Manuelles Schließen
        alertElem.querySelector(".btn-close").onclick = () => {
            alertElem.classList.remove("show");
            setTimeout(() => container.innerHTML = "", 400);
        };
    }

    let auftrittCount = 0;

    async function loadGigs() {
        try {
            const resp = await fetch('gigs.json');
            if (!resp.ok) {
                renderAlert("Konnte gigs.json nicht laden. Starte mit leerem Formular!", "warning");
                throw new Error('Konnte gigs.json nicht laden');
            }
            const gigs = await resp.json();
            const container = document.getElementById("gigsContainer");
            container.innerHTML = "";
            gigs.forEach(gig => {
                container.insertAdjacentHTML("beforeend", buildGigRow(auftrittCount++, gig));
            });
        } catch (err) {
            // Falls Datei fehlt, einfach leer starten
            document.getElementById("gigsContainer").innerHTML = "";
        }
    }

    document.getElementById("addAuftritt").addEventListener("click", function () {
        document.getElementById("gigsContainer").insertAdjacentHTML("beforeend", buildGigRow(auftrittCount++));
    });

    document.getElementById("gigsContainer").addEventListener("click", function (e) {
        const removeBtn = e.target.closest(".removeAuftritt");
        if (removeBtn) {
            removeBtn.closest(".card").remove();
        }
        // Up/Down Buttons
        if (e.target && (e.target.classList.contains("move-up") || e.target.closest(".move-up"))) {
            const card = e.target.closest(".card");
            const prev = card.previousElementSibling;
            if (prev) card.parentNode.insertBefore(card, prev);
        }
        if (e.target && (e.target.classList.contains("move-down") || e.target.closest(".move-down"))) {
            const card = e.target.closest(".card");
            const next = card.nextElementSibling;
            if (next) card.parentNode.insertBefore(next, card);
        }
    });

    document.getElementById("gigsForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const gigs = Array.from(document.querySelectorAll("#gigsContainer .card")).map(card => ({
            date: card.querySelector('input[name="date"]').value,
            location: card.querySelector('input[name="location"]').value,
            time: card.querySelector('input[name="time"]').value,
            desc: card.querySelector('input[name="desc"]').value
        }));
        console.log("Gigs to submit:", JSON.stringify(gigs));

        // Token aus dem Eingabefeld holen
        const token = document.getElementById("githubToken").value.trim();
        if (!token) {
            renderAlert("Bitte GitHub Token eingeben!", "danger");
            return;
        }

        // __Ersetze USER, REPO, WORKFLOW_NAME durch deine Werte__
        const githubApi = "https://api.github.com/repos/Bibo-Joshi/dlm/actions/workflows/edit-events.yml/dispatches";

        try {
            const resp = await fetch(githubApi, {
                method: "POST",
                headers: {
                    "Authorization": `token ${token}`,
                    "Accept": "application/vnd.github.v3+json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    ref: "main",
                    inputs: {gigs: JSON.stringify(gigs)}
                })
            });

            if (resp.ok) {
                renderAlert("Erfolgreich übermittelt!", "success");
            } else {
                const txt = await resp.text();
                renderAlert("Fehler: " + txt, "danger");
            }
        } catch (err) {
            renderAlert("Netzwerkfehler: " + err.message, "danger");
        }
    });

    (() => {
        'use strict'

        const getStoredTheme = () => localStorage.getItem('theme')
        const setStoredTheme = theme => localStorage.setItem('theme', theme)

        const getPreferredTheme = () => {
            const storedTheme = getStoredTheme()
            if (storedTheme) {
                return storedTheme
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        const setTheme = theme => {
            if (theme === 'auto') {
                document.documentElement.setAttribute('data-bs-theme', (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'))
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme)
            }
        }

        setTheme(getPreferredTheme())

        const showActiveTheme = (theme, focus = false) => {
            const themeSwitcher = document.querySelector('#bd-theme')
            if (!themeSwitcher) return

            const themeSwitcherText = document.querySelector('#bd-theme-text')
            const activeThemeIcon = document.querySelector('.theme-icon-active')
            const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`)
            const iconClassMap = {
                light: 'bi-sun-fill',
                dark: 'bi-moon-stars-fill',
                auto: 'bi-circle-half'
            }
            // Setze das Icon entsprechend dem aktiven Theme
            activeThemeIcon.className = `bi ${iconClassMap[theme]} theme-icon-active`

            document.querySelectorAll('[data-bs-theme-value]').forEach(element => {
                element.classList.remove('active')
                element.setAttribute('aria-pressed', 'false')
            })

            btnToActive.classList.add('active')
            btnToActive.setAttribute('aria-pressed', 'true')
            const themeSwitcherLabel = `${themeSwitcherText.textContent} (${btnToActive.dataset.bsThemeValue})`
            themeSwitcher.setAttribute('aria-label', themeSwitcherLabel)

            if (focus) themeSwitcher.focus()
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const storedTheme = getStoredTheme()
            if (storedTheme !== 'light' && storedTheme !== 'dark') {
                setTheme(getPreferredTheme())
            }
        })

        window.addEventListener('DOMContentLoaded', () => {
            // Setze den Text für den Theme-Switcher
            showActiveTheme(getPreferredTheme())
            document.querySelectorAll('[data-bs-theme-value]')
                .forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const theme = toggle.getAttribute('data-bs-theme-value')
                        setStoredTheme(theme)
                        setTheme(theme)
                        showActiveTheme(theme, true)
                    })
                })
            // Lade die vorhandenen Events
            loadGigs();
            // Initialisiere SortableJS mit Drag-Handle
            Sortable.create(document.getElementById("gigsContainer"), {
                animation: 150,
                ghostClass: "sortable-ghost",
                chosenClass: "sortable-chosen",
                dragClass: "sortable-drag",
                handle: ".drag-handle",
                selectedClass: "sortable-selected",
                multiDrag: true,
                fallbackTolerance: 3
            });
        })
    })()
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</body>
</html>
